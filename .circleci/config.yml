version: 2.1

executors:
  unity-executor:
    machine:
      image: ubuntu-2004:current
    resource_class: large

jobs:
  build:
    executor: unity-executor
    steps:
      - checkout

      # Build Project
      - run:
          name: Build project
          command: |
            export UNITY_SERIAL=${UNITY_SERIAL}
            export UNITY_EMAIL=${UNITY_EMAIL}
            export UNITY_PASSWORD=${UNITY_PASSWORD}

            docker run --rm \
              -e UNITY_EMAIL=$UNITY_EMAIL \
              -e UNITY_PASSWORD=$UNITY_PASSWORD \
              -e UNITY_SERIAL=$UNITY_SERIAL \
              -v $(pwd):/project \
              game-ci/unity-builder:latest \
              --targetPlatform Android

      # Upload artifact
      - run:
          name: Archive Build
          command: |
            mkdir -p /tmp/build
            cp -r build/Android/Android.apk /tmp/build/
      - store_artifacts:
          path: /tmp/build
          destination: Build

workflows:
  version: 2
  build-workflow:
    jobs:
      - build:
          context: DreamVillageUnityInfo
          filters:
            branches:
              only: develop
